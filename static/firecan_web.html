<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRECAN</title>
    <link rel="stylesheet" href="./static/leaflet.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="./static/firecan_style.css">


</head>
<body>
    <div class="container-fluid vh-100">

        <div class="row h-100">

            <div id="mainSidebarContent" class="col-12 col-md-1 p-3" style="display: flex; flex-direction: column;">
                <button id="mapButton" class="btn mb-2">Map</button>
                <button id="aboutButton" class="btn mb-2">?</button>
            </div>

            <div id="mapSection" class="col-12 col-md-1 p-3" style="display:none;">

                <button id="mapBackButton" class="btn btn-secondary mb-3">‚Üê</button>
                
                <div id = "gofiler">
                    <div class="d-flex gap-2">
                        <button id="saveButton" type="button" class="flex-fill"></button>
                        <button id="filterButton" type="button" class="flex-fill" onclick="loadFilteredData()">Filter Map</button>
                    </div>

                    <div class="d-grid gap-1 mb-3">
                        <span id="clearFiltersText" onclick="clearFilters()">Clear Filters</span>
                    </div>

                    <div id="loadingMessage" class="alert alert-info text-center fw-bold py-2" style="display:none;">          
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading data<br>This may take several minutes...</p>
                    </div>  

                    <div id="foundMessage" class="alert alert-info text-center fw-bold py-2" style="display:none;">          
                        <p class="mt-2"></p>
                    </div>         
                </div>
                <hr class="sidebar-separator">

                <form>  
                    <div id = "provincecheckboxes">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="QCcheckbox" value="QC" checked>
                            <label class="form-check-label" for="checkbox1">QC</label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="ONcheckbox" value="ON">
                            <label class="form-check-label" for="checkbox2">ON</label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="BCcheckbox" value="BC">
                            <label class="form-check-label" for="checkbox2">BC</label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="ABcheckbox" value="AB">
                            <label class="form-check-label" for="checkbox2">AB</label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="SKcheckbox" value="SK">
                            <label class="form-check-label" for="checkbox2">SK</label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="MBcheckbox" value="MB">
                            <label class="form-check-label" for="checkbox2">MB</label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="YTcheckbox" value="YT">
                            <label class="form-check-label" for="checkbox2">YT</label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="NTcheckbox" value="NT">
                            <label class="form-check-label" for="checkbox2">NT</label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="NScheckbox" value="NS">
                            <label class="form-check-label" for="checkbox2">NS</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="NLcheckbox" value="NL">
                            <label class="form-check-label" for="checkbox2">NL</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="NBcheckbox" value="NB">
                            <label class="form-check-label" for="checkbox2">NB</label>
                        </div>


                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="ALLcheckbox" value="ALL">
                            <label class="form-check-label" for="checkbox2">All</label>
                        </div>


                    </div>
                    <hr class="sidebar-separator">
                    <div id="yearfilterinputs">
                        <label for="minYear" class="year-label">Year</label>
                        <div class="year-inputs" style="display: flex; gap: 1rem;">
                            <input type="text" id="minYear" class="form-control" placeholder="Min Year">
                            <input type="text" id="maxYear" class="form-control" placeholder="Max Year">
                        </div>
                    </div>
                    <hr class="sidebar-separator">
                    <div id="sizefilterinputs">
                        <label for="minSize" class="size-label">Size (HA)</label>
                        <div class="size-inputs" style="display: flex; gap: 1rem;">
                            <input type="text" id="minSize" class="form-control" placeholder="Min Size">
                            <input type="text" id="maxSize" class="form-control" placeholder="Max Size">
                        </div>
                    </div>
                    <hr class="sidebar-separator">
                    <div id="locationfilterinputs">
                        <label for="distanceCoords" class="location-label">Location</label>
                        <div class="location-inputs" style="display: flex; gap: 1rem;">
                            <input type="text" id="distanceCoords" class="form-control" placeholder="Coords">
                            <input type="text" id="distanceRadius" class="form-control" placeholder="Radius (km)">
                        </div>
                    </div>
                <hr class="sidebar-separator">
                    <div id="watershedfilterinput" class="mb-3">
                        <label for="watershedName" class="filter-label">Watershed</label>
                        <input type="text" id="watershedName" class="form-control" placeholder="eg. YAMASKA">
                    </div>
                </form>

                <hr class="sidebar-separator">
                <div class="d-flex justify-content-between gap-1">
                    <button id="watershedExplorerButton" class="btn mb-2">üíß</button>
                    <button id="polygonTolButton" class="btn mb-2">‚ñ≤</button>
                </div>
            </div>

            <div id="aboutSection" class="col-12 col-md-1 p-3" style="display:none;">
                <button id="aboutBackButton" class="btn btn-secondary mb-3">‚Üê</button>
                <h4>About FIRECAN</h4>
                <p><strong>Firecan</strong> is a collection of historical forest fires data in Canada<br>
                Currently, Firecan supports <strong>Quebec</strong> and <strong>Ontario</strong></p>


                <p>
                    <strong style="font-size: 24px;">Filter Data</strong><br>
                    Input your desired filters and click "Filter Map" to see your fires on the map.<br>
                    BE CAREFUL!: Theses datasets hold hundreds of thousands of rows, FOCUS your filters or LOWER polygon tolerance to minimize file size (5 mb) and server costs<br>
                    You can filter by <u>Year</u>, <u>Size</u>, <u>Radius</u> around a location and <u>Watershed</u><br>
                    When using the <u>Year/Size</u> filter it is good practice input an upper and lower bound or else large amounts of the dataset will load<br>
                    <strong style="font-size: 24px;">Base Map</strong><br>
                    Change the basemap using the pop-up in the top right of the map.<br>
                    <strong style="font-size: 24px;">Download Data</strong><br>
                    Download filtered data by entering your desired filters, choosing a format, and then clicking "Download Data" button<br>
                    <strong style="font-size: 24px;">Watershed Explorer</strong><br>
                    To see all available watersheds, click on the üíß button<br>
                    Copy and Paste the watershed name into the watershed filter box<br>
                    <strong style="font-size: 24px;">Polygon Tolerance</strong><br>
                    To increases the accuracy of the polgyons, input a smaller number (m of polygon deviation allowed) in ‚ñ≤ popup
                </p>

                <p><strong>Data Sources:</strong></p>
                <ul>
                    <li>Quebec Fires: <a href="https://www.donneesquebec.ca/recherche/dataset/bassins-hydrographiques-multi-echelles-du-quebec" target="_blank">https://www.donneesquebec.ca/recherche/dataset/bassins-hydrographiques-multi-echelles-du-quebec</a></li>
                    <li>Quebec Watersheds: <a href="https://www.donneesquebec.ca/recherche/dataset/bassins-hydrographiques-multi-echelles-du-quebec" target="_blank">https://www.donneesquebec.ca/recherche/dataset/bassins-hydrographiques-multi-echelles-du-quebec</a></li>
                    <li>Ontario Fires: <a href="https://data.ontario.ca/dataset/fire-disturbance-area-firedstb" target="_blank">https://data.ontario.ca/dataset/fire-disturbance-area-firedstb</a></li>
                </ul>

            </div>

            <div class="col p-0" id="map" style="height: 100vh; min-height: 400px;"></div>

        </div>


        <div id="introModal" >
            <div class="modal-content">
                <div class="mb-2">
                <h2 id = "introTitle">FIRECAN</h2>
                <p id = "introText">- <strong>Firecan</strong> is a collection of historical forest fires data in Canada<br>
                - Enter your desired filters and click <strong>Filter Map</strong> to display data<br>
                - The server has a cap of 8mb so ensure your filters are specfic<br>
                - Click on the <strong>Water Drop</strong> button to see all available watersheds<br>
                - Click on the  <strong>Triangle</strong> button to change the Polygon Tolerance</p>
                </div>
            </div>
        </div>


        <div id="downloadModal" style="display: none;">
            <div class="modal-content">
                <span class="close" id="closeDownloadModal">&times;</span>
                <h5>Download Data</h5>

                <div class="mb-2">
                    <label for="downloadFormat" class="form-label">Download Format</label>
                    <select id="downloadFormat" class="form-select">
                        <option value="csv" selected>CSV</option>
                        <option value="json">GeoJSON</option>
                        <option value="gpkg">GPKG (GeoPackage)</option>
                    </select>
                </div>

                <div class="d-grid mt-3">
                    <button id="downloadButton" class="btn btn-primary" type="button">Download Data</button>
                </div>

                <div id="downloadingMessage" class="alert alert-info text-center fw-bold py-2 mt-3" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data<br>This may take several minutes...</p>
                </div>

                <div id="downloadingfoundMessage" class="alert alert-info text-center fw-bold py-2 mt-2" style="display:none;">          
                    <p class="mt-2"></p>
                </div>
            </div>
        </div>

        <div id="watershedModal" class="modal">
            <span class="close">&times;</span>
            <div id="watershedMap"></div>
            <div id="spinner" class="spinner-border text-primary position-absolute top-50 start-50 translate-middle" role="status" hidden>
                <span class="visually-hidden">Loading...</span>
              </div>
        </div>

        <div id="polygonTolModal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div class="mb-2">
                    <label for="polygonTol" class="form-label">Polygon Tolerance (m)</label>
                    <input type="text" id="polygonTol" class="form-control" placeholder="100">
                </div>
                <div class="d-grid mt-3">
                    <button id="savePolygonTol" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>


    </div>
    <script src="./static/leaflet.js"></script>
    <script src="./static/firecan_logic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Download modal -->
    <script>
    const saveButton = document.getElementById("saveButton");
    const downloadModal = document.getElementById("downloadModal");
    const closeDownloadModal = document.getElementById("closeDownloadModal");

    saveButton.addEventListener("click", () => {
        downloadModal.style.display = "flex";
    });

    closeDownloadModal.addEventListener("click", () => {
        downloadModal.style.display = "none";
    });

    // Close modal if clicking outside content
    downloadModal.addEventListener("click", (e) => {
        if (e.target === downloadModal) {
            downloadModal.style.display = "none";
        }
    });

    // Keep your existing download function intact
    document.getElementById("downloadButton").addEventListener("click", downloadFilteredData);
    </script>
    <!-- Main Side Bar Button Clicks -->
    <script>
        const mapBackButton = document.getElementById("mapBackButton");
        const aboutBackButton = document.getElementById("aboutBackButton");
        const mainSidebarContent = document.getElementById("mainSidebarContent");

        const aboutButton = document.getElementById("aboutButton");
        const aboutSection = document.getElementById("aboutSection");

        const mapButton = document.getElementById("mapButton");
        const mapSection = document.getElementById("mapSection"); // Make sure this is a separate div!

        // Function to open a section
        function openSection(section) {
            mainSidebarContent.style.display = "none";
            section.style.display = "block";
        }

        // Function to go back to main sidebar
        function goBack() {
            aboutSection.style.display = "none";
            mapSection.style.display = "none";
            mainSidebarContent.style.display = "block";
        }

        mapBackButton.addEventListener("click", goBack);
        aboutBackButton.addEventListener("click", goBack);
        aboutButton.addEventListener("click", () => openSection(aboutSection));
        mapButton.addEventListener("click", () => openSection(mapSection));
        backButton.addEventListener("click", goBack);
    </script>
    <!-- Intro Modal -->
    <script>
        const introModal = document.getElementById("introModal");
        window.addEventListener("load", () => {
            introModal.style.display = "flex";
        });
        introModal.addEventListener("click", (e) => {
            if (e.target === introModal) {
                introModal.style.display = "none";
            }
        });
    </script>
    <!-- Polygon Tolerance -->
     <script>
        const polygonTolButton = document.getElementById("polygonTolButton");
        const polygonTolModal = document.getElementById("polygonTolModal");
        const polygonCloseBtn = polygonTolModal.querySelector(".close");
        let savedPolygonTolerance = 1000;
        const polygonInput = document.getElementById("polygonTol");
        const savePolygonTol = document.getElementById("savePolygonTol");

        
        polygonTolButton.addEventListener("click", () => {
            polygonTolModal.style.display = "flex";
            
            if (savedPolygonTolerance !== null) {
                polygonInput.value = savedPolygonTolerance;
            }
        });

        
        polygonCloseBtn.addEventListener("click", () => {
            polygonTolModal.style.display = "none";
        });

        polygonTolModal.addEventListener("click", (e) => {
            if (e.target === polygonTolModal) {
                polygonTolModal.style.display = "none";
            }
        });

        
        savePolygonTol.addEventListener("click", () => {
            const tolValue = polygonInput.value.trim();
            if (!tolValue || isNaN(tolValue)) {
                alert("Please enter a valid number for polygon tolerance.");
                return;
            }
            savedPolygonTolerance = parseFloat(tolValue);
            polygonTolModal.style.display = "none";
            console.log("Saved polygon tolerance:", savedPolygonTolerance);
        });

        polygonTolModal.addEventListener("click", (e) => {
            if (e.target === polygonTolModal) {
                polygonTolModal.style.display = "none";
            }
        });
     </script>    
    <!-- Watershed Explorer -->
    <script>
        const watershedButton = document.getElementById("watershedExplorerButton");
        const modal = document.getElementById("watershedModal");
        const closeBtn = document.querySelector(".close");

        let watershedMap = null;
        let watershedLayer = null;
        let watershedData = null;


        function showMap(){
            if (!watershedMap) {
                
                watershedMap = L.map('watershedMap').setView([52.520878, -69.855725], 5);  

                
                Esrimap = L.tileLayer(
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                { maxZoom: 18, attribution: 'Tiles ¬© Esri' }
                ).addTo(watershedMap);

                
            if (watershedData) {
            watershedLayer = L.geoJSON(watershedData, {
                style: function(feature) {                                                                               // THis styles the polygons that are displayed on the map 
                    return {
                        color: "#031cfc",
                        weight: 1,                                                                                       // Big weight to make the polygons visible from zoomed out 
                        opacity: 1,
                        fillColor: "#aedffd",
                        fillOpacity: 0.5                                                                                 // Lower opacity looks better, and helps distinguish from polygon fill and border on map (useful when many polygons are next to each other)
                    };
                },
                onEachFeature: function(feature, layer) {                                                               // This creates a pop up when clicking on polygons that say the year and its size, this was half taken from Ottowa demo and half AI.
                    if (feature.properties) {                   
                        let popupContent = `
                            <b>Watershed Details</b><br>
                            Watershed: ${feature.properties.NOM_COURS_DEAU}<br>
                        `;
                        layer.bindPopup(popupContent);
                    }
                },
            }).addTo(watershedMap);


            watershedMap.fitBounds(watershedLayer.getBounds());
            } else {
            console.warn("Watershed data not ready yet.");
            }
            } else {
                watershedMap.invalidateSize(); 
            }
        }
        watershedButton.addEventListener("click", () => {
            modal.style.display = "block";
            if (!watershedData) {
                spinner.hidden = false;
                fetch("/static/qc_watershed_data.geojson")  
                    .then(res => res.json())
                    .then(data => {
                        watershedData = data;  
                        showMap();
                })
                .catch(err => console.error("Failed to load watershed data", err))
                .finally(() => {
                    spinner.hidden = true;
                });
            }
            else{
                showMap();
            }
        });
        closeBtn.addEventListener("click", () => {
            modal.style.display = "none";
        });
        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.style.display = "none";
            }
        });
    </script>
    <!-- Map Coordinates on Click -->
    <script>
        map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lon = e.latlng.lng.toFixed(6); 
        L.popup()
            .setLatLng(e.latlng)
            .setContent(`${lat}, ${lon}`)
            .openOn(map);
        });
    </script>
    <!-- Clear Filters -->
    <script>
        function clearFilters() {
            // Uncheck all province checkboxes
            const checkboxes = document.querySelectorAll("#provincecheckboxes input[type='checkbox']");
            checkboxes.forEach(checkbox => checkbox.checked = false);

            // Clear all text inputs within the form
            const inputs = document.querySelectorAll("#mapSection input[type='text']");
            inputs.forEach(input => input.value = "");

            // Reset download format
            const downloadFormat = document.getElementById("downloadFormat");
            if (downloadFormat) downloadFormat.value = "csv";

            // Reset polygon tolerance input if available
            if (typeof savedPolygonTolerance !== 'undefined' && polygonInput) {
                polygonInput.value = savedPolygonTolerance;
            }

            console.log("Filters cleared.");
        }
            </script>
</body>
</html>










    <!-- Sidebar Resizer -->
    <!-- <script>
const resizer = document.getElementById("resizer");
const sidebar = document.getElementById("sidebar");

// Minimum and maximum width of the sidebar
const MIN_WIDTH = 50;
const MAX_WIDTH = 600;

let startX = 0;
let startWidth = 0;
let isResizing = false;

// Start resizing
resizer.addEventListener("mousedown", (e) => {
    isResizing = true;
    startX = e.clientX;
    startWidth = sidebar.offsetWidth;

    // Add listeners to document for dragging
    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);

    // Prevent text selection while dragging
    document.body.style.userSelect = 'none';
});

// Function to handle mouse move
function onMouseMove(e) {
    if (!isResizing) return;

    const dx = e.clientX - startX;
    let newWidth = startWidth + dx;

    // Clamp the width between min and max
    newWidth = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH, newWidth));

    sidebar.style.width = `${newWidth}px`;
}

// Stop resizing
function onMouseUp() {
    isResizing = false;

    // Remove event listeners
    document.removeEventListener("mousemove", onMouseMove);
    document.removeEventListener("mouseup", onMouseUp);

    // Restore text selection
    document.body.style.userSelect = '';
}

    </script> -->