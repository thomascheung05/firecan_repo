<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRECAN</title>
    <link rel="stylesheet" href="./static/leaflet.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="./static/firecan_style.css">


</head>
<body>
    <div class="container-fluid vh-100">

        <div class="row h-100">

            <div class="col-12 col-md-1 p-3" id="sidebar">

                <div id="mainSidebarContent">

                    <div class="d-grid gap-2 mb-3">
                    <button id="filterButton" onclick="loadFilteredData()">Filter Map</button>
                    </div>
                    <hr class="sidebar-separator">
                    <form>  
                        <div id="loadingMessage" class="alert alert-info text-center fw-bold py-2" style="display:none;">          
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading data<br>This may take several minutes...</p>
                        </div>

                        <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="quebeccheckbox" value="qc" checked>
                        <label class="form-check-label" for="checkbox1">QC</label>
                        </div>

                        <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="ontariocheckbox" value="on" checked>
                        <label class="form-check-label" for="checkbox2">ON</label>
                        </div>

                        <div class="mb-2">
                            <label for="minYear" class="form-label">Minimum Year</label>
                            <input type="text" id="minYear" class="form-control" placeholder="eg. 1890">
                        </div>

                        <div class="mb-2">
                            <label for="maxYear" class="form-label">Maximum Year</label>
                            <input type="text" id="maxYear" class="form-control" placeholder="eg. 2024">
                        </div>

                        <div class="mb-2">
                            <label for="minSize" class="form-label">Minimum Size</label>
                            <input type="text" id="minSize" class="form-control" placeholder="eg. 0">
                        </div>

                        <div class="mb-2">
                            <label for="maxSize" class="form-label">Maximum Size</label>
                            <input type="text" id="maxSize" class="form-control" placeholder="eg. 5000.2">
                        </div>

                        <div class="mb-2">
                            <label for="distanceCoords" class="form-label">Coordintes (lat, lon)</label>
                            <input type="text" id="distanceCoords" class="form-control" placeholder="e.g., 51.862924, -88.033121">
                        </div>

                        <div class="mb-2">
                            <label for="distanceRadius" class="form-label">Radius (km)</label>
                            <input type="text" id="distanceRadius" class="form-control" placeholder="e.g., 10">
                        </div>

                        <div class="mb-3">
                            <label for="watershedName" class="form-label">Watershed</label>
                            <input type="text" id="watershedName" class="form-control" placeholder="eg. YAMASKA">
                        </div>
                        
                        <hr class="sidebar-separator">

                        <div class="mb-1">
                            <label for="downloadFormat" class="form-label">Download Format</label>
                            <select id="downloadFormat" class="form-select">
                                <option value="csv" selected>CSV</option>
                                <option value="json">GeoJSON</option>
                                <option value="gpkg">GPKG (GeoPackage)</option>
                            </select>
                        </div>

                        <div class="d-grid gap-2 mb-3">
                            <button id="downloadButton" onclick="downloadFilteredData()" type="button">Download Data</button>
                        </div>

                        <div id="downloadingMessage" class="alert alert-info text-center fw-bold py-2" style="display:none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>

                            <p class="mt-2">Loading data<br>This may take several minutes...</p>
                        </div>

                    </form>

                    <hr class="sidebar-separator">

                    <div class="d-flex gap-2 mb-3">
                        <button id="aboutButton" class="btn btn-light flex-fill">?</button>
                        <button id="watershedExplorerButton" class="btn btn-light flex-fill">üíß</button>
                        <button id="polygonTolButton" class="btn btn-light flex-fill">‚ñ≤</button>
                    </div>

                </div>


                
                <div id="aboutSection" style="display:none;">
                    <button id="backButton" class="btn btn-secondary mb-3">‚Üê</button>
                    <h4>About FIRECAN</h4>
                    <p><strong>Firecan</strong> is a collection of historical forest fires data in Canada<br>
                    Currently, Firecan supports <strong>Quebec</strong> and <strong>Ontario</strong></p>


                    <p>
                        <strong style="font-size: 24px;">Filter Data</strong><br>
                        Input your desired filters and click "Filter Map" to see your fires on the map.<br>
                        BE CAREFUL!: Theses datasets hold hundreds of thousands of rows, FOCUS your filters or LOWER polygon tolerance to minimize file size (8 mb) and server costs please!<br>
                        You can filter by <u>Year</u>, <u>Size</u>, <u>Radius</u> around a location and <u>Watershed</u><br>
                        When using the <u>Year/Size</u> filter it is good practice input an upper and lower bound or else large amounts of the dataset will load<br>
                        <strong style="font-size: 24px;">Base Map</strong><br>
                        Change the basemap using the pop-up in the top right of the map.<br>
                        <strong style="font-size: 24px;">Download Data</strong><br>
                        Download filtered data by entering your desired filters, choosing a format, and then clicking "Download Data" button<br>
                        <strong style="font-size: 24px;">Watershed Explorer</strong><br>
                        To see all available watersheds, click on the üíß button<br>
                        <strong style="font-size: 24px;">Polygon Tolerance</strong><br>
                        To increases the accuracy of the polgyons, input a smaller number (m of polygon deviation allowed) in ‚ñ≤ popup
                    </p>

                    <p><strong>Data Sources:</strong></p>
                    <ul>
                        <li>Quebec Fires: <a href="https://www.donneesquebec.ca/recherche/dataset/bassins-hydrographiques-multi-echelles-du-quebec" target="_blank">https://www.donneesquebec.ca/recherche/dataset/bassins-hydrographiques-multi-echelles-du-quebec</a></li>
                        <li>Quebec Watersheds: <a href="https://www.donneesquebec.ca/recherche/dataset/bassins-hydrographiques-multi-echelles-du-quebec" target="_blank">https://www.donneesquebec.ca/recherche/dataset/bassins-hydrographiques-multi-echelles-du-quebec</a></li>
                        <li>Ontario Fires: <a href="https://data.ontario.ca/dataset/fire-disturbance-area-firedstb" target="_blank">https://data.ontario.ca/dataset/fire-disturbance-area-firedstb</a></li>
                    </ul>

                </div>


            </div>

            <div id="resizer"></div>  

            <div class="col p-0" id="map" style="height: 100vh; min-height: 400px;"></div>

        </div>

        <div id="watershedModal" class="modal">
            <span class="close">&times;</span>
            <div id="watershedMap"></div>
            <div id="spinner" class="spinner-border text-primary position-absolute top-50 start-50 translate-middle" role="status" hidden>
                <span class="visually-hidden">Loading...</span>
              </div>
        </div>

        <div id="polygonTolModal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div class="mb-2">
                    <label for="polygonTol" class="form-label">Polygon Tolerance (m)</label>
                    <input type="text" id="polygonTol" class="form-control" placeholder="100">
                </div>
                <div class="d-grid mt-3">
                    <button id="savePolygonTol" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>


    </div>
    <script src="./static/leaflet.js"></script>
    <script src="./static/firecan_logic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Sidebar Resizer -->
    <script>
        const resizer = document.getElementById("resizer");
        const sidebar = document.getElementById("sidebar");
        let x = 0;
        let sidebarWidth = 0;

        resizer.addEventListener("mousedown", (e) => {
        ¬† x = e.clientX;
        ¬† sidebarWidth = sidebar.offsetWidth;

        ¬† document.addEventListener("mousemove", resize, false);
        ¬† document.addEventListener("mouseup", stopResize, false);
        });

        function resize(e) {
        ¬† const dx = e.clientX - x;
        ¬† const newWidth = sidebarWidth + dx;
        ¬† if (newWidth > 50 && newWidth < 600) { 
        ¬† ¬† sidebar.style.width = `${newWidth}px`;
        ¬† }
        }

        function stopResize() {
        ¬† document.removeEventListener("mousemove", resize, false);
        ¬† document.removeEventListener("mouseup", stopResize, false);
        }
    </script>
    <!-- About Section -->
    <script>
        const aboutButton = document.getElementById("aboutButton");
        const backButton = document.getElementById("backButton");
        const mainSidebarContent = document.getElementById("mainSidebarContent");
        const aboutSection = document.getElementById("aboutSection");

        aboutButton.addEventListener("click", () => {
            mainSidebarContent.style.display = "none";
            aboutSection.style.display = "block";
        });

        backButton.addEventListener("click", () => {
            aboutSection.style.display = "none";
            mainSidebarContent.style.display = "block";
        });
    </script>
    <!-- Polygon Tolerance -->
     <script>
        const polygonTolButton = document.getElementById("polygonTolButton");
        const polygonTolModal = document.getElementById("polygonTolModal");
        const polygonCloseBtn = polygonTolModal.querySelector(".close");
        let savedPolygonTolerance = 1000;
        const polygonInput = document.getElementById("polygonTol");
        const savePolygonTol = document.getElementById("savePolygonTol");

        
        polygonTolButton.addEventListener("click", () => {
            polygonTolModal.style.display = "flex";
            
            if (savedPolygonTolerance !== null) {
                polygonInput.value = savedPolygonTolerance;
            }
        });

        
        polygonCloseBtn.addEventListener("click", () => {
            polygonTolModal.style.display = "none";
        });

        polygonTolModal.addEventListener("click", (e) => {
            if (e.target === polygonTolModal) {
                polygonTolModal.style.display = "none";
            }
        });

        
        savePolygonTol.addEventListener("click", () => {
            const tolValue = polygonInput.value.trim();
            if (!tolValue || isNaN(tolValue)) {
                alert("Please enter a valid number for polygon tolerance.");
                return;
            }
            savedPolygonTolerance = parseFloat(tolValue);
            polygonTolModal.style.display = "none";
            console.log("Saved polygon tolerance:", savedPolygonTolerance);
        });

        polygonTolModal.addEventListener("click", (e) => {
            if (e.target === polygonTolModal) {
                polygonTolModal.style.display = "none";
            }
        });
     </script>    
    <!-- Watershed Explorer -->
    <script>
        const watershedButton = document.getElementById("watershedExplorerButton");
        const modal = document.getElementById("watershedModal");
        const closeBtn = document.querySelector(".close");

        let watershedMap = null;
        let watershedLayer = null;
        let watershedData = null;


        function showMap(){
            if (!watershedMap) {
                
                watershedMap = L.map('watershedMap').setView([52.520878, -69.855725], 5);  

                
                Esrimap = L.tileLayer(
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                { maxZoom: 18, attribution: 'Tiles ¬© Esri' }
                ).addTo(watershedMap);

                
            if (watershedData) {
            watershedLayer = L.geoJSON(watershedData, {
                style: function(feature) {                                                                               // THis styles the polygons that are displayed on the map 
                    return {
                        color: "#031cfc",
                        weight: 1,                                                                                       // Big weight to make the polygons visible from zoomed out 
                        opacity: 1,
                        fillColor: "#aedffd",
                        fillOpacity: 0.5                                                                                 // Lower opacity looks better, and helps distinguish from polygon fill and border on map (useful when many polygons are next to each other)
                    };
                },
                onEachFeature: function(feature, layer) {                                                               // This creates a pop up when clicking on polygons that say the year and its size, this was half taken from Ottowa demo and half AI.
                    if (feature.properties) {                   
                        let popupContent = `
                            <b>Watershed Details</b><br>
                            Watershed: ${feature.properties.NOM_COURS_DEAU}<br>
                        `;
                        layer.bindPopup(popupContent);
                    }
                },
            }).addTo(watershedMap);


            watershedMap.fitBounds(watershedLayer.getBounds());
            } else {
            console.warn("Watershed data not ready yet.");
            }
            } else {
                watershedMap.invalidateSize(); 
            }
        }
        watershedButton.addEventListener("click", () => {
            modal.style.display = "block";
            if (!watershedData) {
                spinner.hidden = false;
                fetch("/static/qc_watershed_data.geojson")  
                    .then(res => res.json())
                    .then(data => {
                        watershedData = data;  
                        showMap();
                })
                .catch(err => console.error("Failed to load watershed data", err))
                .finally(() => {
                    spinner.hidden = true;
                });
            }
            else{
                showMap();
            }
        });
        closeBtn.addEventListener("click", () => {
            modal.style.display = "none";
        });
        modal.addEventListener("click", (e) => {
            if (e.target === polygonTolModal) {
                polygonTolModal.style.display = "none";
            }
        });
    </script>
    <!-- Map Coordinates on Click -->
    <script>
        map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lon = e.latlng.lng.toFixed(6); 
        L.popup()
            .setLatLng(e.latlng)
            .setContent(`${lat}, ${lon}`)
            .openOn(map);
        });
    </script>
</body>
</html>
